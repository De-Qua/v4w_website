<!DOCTYPE html>
<html>
	<title>De Qua</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- we should think about SEO, keywords, descriptions, ecc... -->
	<meta name="description" content="Find your way through Venice - Trova la tua strada a Venezia">
	<!-- penso che ora non venga più usata la tag keyword -->
  <meta name="keywords" content="DeQua, Venezia, Strada, Ponte, Calle, Indirizzo, Sestiere">
	<!-- autori -->
	<meta name="author" content="Dequa">
	<link rel="stylesheet" href="/static/css/bootstrap.min.css" >
	<!-- <link rel="stylesheet" href="/static/css/owl.carousel.min.css">
	<link rel="stylesheet" href="/static/css/owl.theme.default.min.css"> -->
	<link rel="stylesheet" href="/static/css/w3s.css">
	<link rel="stylesheet" href="/static/css/s.css">
	<link rel="stylesheet" href="/static/css/easy-button.css">
	<link rel="stylesheet" href="/static/css/MarkerCluster.css">
	<link rel="stylesheet" href="/static/css/MarkerCluster.Default.css">
  <link rel="icon" href="/static/img/dequa_logo_v2.png">

	<link rel="stylesheet" href="/static/css/leaflet.css">
	 <!-- Make sure you put this AFTER Leaflet's CSS -->
	<link rel="stylesheet" href="/static/font-awesome-4.7.0/css/font-awesome.min.css">
	<!-- <script src="https://kit.fontawesome.com/c02ec4320e.js" crossorigin="anonymous"></script> -->
	<link rel="stylesheet" href="/static/css/L.Control.Locate.min.css">


	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="/static/js/leaflet.js"></script>
	<script src="/static/js/L.Control.Locate.min.js"></script>
	<!-- PROVIDERS FOR DIFFERENT MAP TYPES -->
	<script src="/static/js/leaflet-providers.js"></script>
	<!-- Our own (little) javascript library. -->
	<script src="/static/js/v4w.js"></script>
	<!-- BOOTSTARP -->
	<script src="/static/js/jquery-3.5.1.min.js"></script>
	<script src="/static/js/bootstrap.bundle.min.js"> </script>
	<!--<script src="/static/js/owl.carousel.min.js"></script>-->
	<script src="/static/js/easy-button.js"></script>
	<script src="/static/js/leaflet.markercluster.js"></script>
	<script src="/static/js/leaflet-color-markers.js"></script>
<body onbeforeunload="HandleBackFunctionality()">
	<!-- Initialize popover -->
<script>
	$(function () {
	$('[data-toggle="popover"]').popover()
	})
</script>

	<!-- Container con sidebar e mappa -->
<div id=container>
	<div id="sidebar" style="display: none;">
		<div class=sidebar-wrapper>
			<div class="card" id="features">
        <div id="result_title" class="card-header"><h3><b>Risultati</b>
					<a onclick="hideSidebar()">
          	<button type="button" class="btn btn-sm btn-outline-secondary float-right" id="sidebar-hide-btn"><i class="fa fa-chevron-left"></i></button></h3>
					</a>
				</div>
			</div>
			<div class="sidebar-table">
				<div class="possibilities" id="possibilitiesFather"><!-- se vogliamo il carosello owl-carousel owl-theme -->
				</div>
			</div>
		</div>
	</div>

	<div class="loader" style="display:none;" id="loading">
		<!-- <img id="loading_gif" src="/static/assets/loading.gif"> -->
		<div class="spinner-border text-warning" role="status">
		  <span class="sr-only">Loading...</span>
		</div>
	</div>

	<!-- DIV CON LA MAPPA -->
	<div class="map-container leaflet-container leaflet-retina leaflet-fade-anim" tabindex="0" id="mapcontainer">
		<div id="mapid">
		<script>
			// Create a variable with already both layer
			var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				minZoom: 12,
		    maxZoom: 19,
		    minNativeZoom: 12,
		    maxNativeZoom: 19,
				zoomControl: false,
				attribution: 'DeQua | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			});
			var esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
				minZoom: 12,
		    maxZoom: 19,
		    minNativeZoom: 12,
		    maxNativeZoom: 19,
				zoomControl: false,
				attribution: 'DeQua | Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
			});

			var baseMaps = {
				"OpenStreetMap": osm,
				"ESRIMap": esri
			}
			var whichmap = "OpenStreetMap";

			var mymap = L.map('mapid',{
				layers: baseMaps[whichmap]
			});

			var possibilitiesLayer = L.markerClusterGroup();

			var highlightPane = mymap.createPane("highlightPane");
			highlightPane.style.zIndex = 700;
			var highlight = L.geoJson(null,{pane: "highlightPane"}).addTo(mymap);
			var highlightStyle = {
			  stroke: false,
			  fillColor: "#ffb400",
			  fillOpacity: 0.9,
			  radius: 10,
				className: 'blinking',
				pane: "highlightPane"
			};

			// Create markers for start and end
			var marker_start = L.marker([],{icon: greenIcon});
			var marker_end = L.marker([],{icon:redIcon});

			//L.control.layers(baseMaps).addTo(mymap);
			// var OpenStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			// minZoom: 12,
	    // maxZoom: 19,
	    // minNativeZoom: 12,
	    // maxNativeZoom: 19,
			// zoomControl: false,
			// attribution: 'DeQua | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			// }).addTo(mymap);
			//OpenStreetMap_DE = L.tileLayer.provider('Stamen.Watercolor').addTo(mymap);
			// Zoom buttons to the bottom right
			mymap.zoomControl.setPosition('bottomright');
			// a random marker to show a markers are used
			//var marker = L.marker([45.43, 12.33]).addTo(mymap);
			//var marker;
			//var circle;
			L.control.locate({
		    position: 'bottomright',
		    strings: {
		        title: "Show me where I am, yo!"
		    }
				}).addTo(mymap);
			var scale = L.control.scale().addTo(mymap);
		</script>
	</div>
		<!-- DIV IN ALTO A SINISTRA - QUI LA BARRA DI RICERCA -->
		<!-- per essere cliccato e usato da telefono, deve stare fuori dalla mappa! Se no l'utente clicca la mappa e non la barra di ricerca! -->

		<!-- leaflet top lo mantiene in alto e sopra lo schermo, lg-4 resposnive -->
		<div class="leaflet-top col no-gutters" id="searchbar">
			<!-- button works because of this -->
			<div class="row">
				<div class=col-lg-4>
					<div class="row">
						<div class="leaflet-control col-md-12">
							<form id="ricerca_ind" action="" method="GET" onsubmit="drawPreLoader()">
								<!-- PRIMA RIGA: BARRA DI RICERCA -->
								<div class="row">
									<!-- A sinistra la barra di ricerca -->
									<div class="col-10">
										<div class="input-group">
											<div class="input-group-prepend">
										    <button class="input-group-text btn bg-white border-right-0 border" type="button" id="startFromWhereIAMbtn">
													<i class="fa fa-bullseye"></i>
												</button>
												<script>
													document.getElementById('startFromWhereIAMbtn').onclick = function() { copyMyPositionAsStart(mymap); };
												</script>
										  </div>
										  <input type="text" class="form-control" placeholder="cerca..." aria-label="" aria-describedby="basic-addon1" name="partenza" id="search_field_1" oninput="useristypingin('search_field_1')">
											<!-- A hidden input takes the coordinates for the start location and we can store them here: it will never be visible -->
											<input type="text" name="start_coord" id="hidden_start_coord" style="display: none">
											<div class="input-group-append">
										    <button class="input-group-text btn bg-white border-left-0 border" type="button" id="search_field_1_x" onclick="clearField('search_field_1')">
													<i class="fa fa-times"></i>
												</button>
										  </div>
										</div>
										<!-- <input type="text"  placeholder="cerca.." name="partenza" class="form-control" id="search_field_1"> -->
									</div>
									<!-- A destra il pulsante per cercare -->
									<div class="col-1 align-self-center">
										<button class="btn btn-sm btn-light v4wbtn" type="submit" form="ricerca_ind" id="searchbtn"><img src="/static/img/dequa_logo_v2.png" style="width:20px;margin-left: -3px;"></button>
										<!-- <div id="start_from_my_location" style="display: none">
											<button class="btn btn-sm btn-light v4wbtn" type=button id="startFromWhereIAMbtn"><i class="fa fa-fw fa-location-arrow"></i></button>
											<script>
												document.getElementById('startFromWhereIAMbtn').onclick = function() { copyMyPositionAsStart(mymap); };
											</script>
										</div> -->
									</div>
								</div>

								<!-- SECONDA RIGA: BOTTONE PER AGGIUNGERE LA SECONDA BARRA DI RICERCA -->
								<div class="row">
									<div class="col align-self-center">
										<!-- inizialmente mostriamo il bottone -->
										<div class="button-plus" id="add-searchfield">
											<a onclick="showSecondSearchbar()">
												<button type=button id="btn-plus" class="btn btn-sm btn-light v4wbtn"><img src="/static/icons/iconfinder_path_2969396.svg" class="icon fa-fw p-0"></button>
											</a>
										</div>
									</div>
								</div>

								<!-- quando uno preme, nascondiamo il bottone e mostriamo il secondo campo di ricerca -->
								<div class="container-search-field" id="second-search-field" style="display: none">
									<!-- SECONDA RIGA: BARRA DI RIRCERCA -->
									<div class="row">
										<div class="col-10">
											<div class="input-group">
												<div class="input-group-prepend">
											    <button class="input-group-text btn bg-white border-right-0 border" type="button" onclick="hideSecondSearchbar()">
														<i class="fa fa-minus-square-o"></i>
													</button>
											  </div>
											  <input type="text" class="form-control" placeholder="fino a..." aria-label="" aria-describedby="basic-addon1" name="arrivo" id="search_field_2" oninput="useristypingin('search_field_2')">
												<!-- A hidden input takes the coordinates for the end location and we can store them here: it will never be visible -->
												<input type="text" name="end_coord" id="hidden_end_coord" style="display: none">
												<div class="input-group-append">
											    <button class="input-group-text btn bg-white border-left-0 border" type="button" id="search_field_2_x" onclick="clearField('search_field_2')">
														<i class="fa fa-times"></i>
													</button>
											  </div>
											</div>
											<!-- <input type="text" name="arrivo" placeholder="fino a.." class="form-control" id="search_field_2"> -->
										</div>
										<div class="col-1 align-self-center">
											<button type=button onclick="swapDirections()" class="btn btn-sm btn-light v4wbtn"><i class="fa fa-fw fa-exchange fa-rotate-90"></i></button>
										</div>
									</div>
									<!-- TERZA RIGA: BOTTONI + trova la strada-->
									<div class="row space_above">
										<div class="col-10">
											<div id="nav_buttons" style="display: none">
												<label class="btn btn-sm btn-light v4wbtn" title="Strada a piedi"><input type="checkbox" form="ricerca_ind" name="walk" id="walk_setting" checked><img src="/static/icons/pedone.svg" class="icon"></input></label>
												<label class="btn btn-sm btn-light v4wbtn" title="Strada con meno ponti"><input type="checkbox" form="ricerca_ind" name="lazy" id="less_bridges_setting"><img src="/static/icons/carretto.svg" class="icon"></input></label>
												<label class="btn btn-sm btn-light v4wbtn" title="Strada in barca"><input type="checkbox" form="ricerca_ind" name="boat" id="boat_setting"><img src="/static/icons/barchin.svg" class="icon"></input></label>
												<span tabindex="0" class="d-inline-block" data-toggle="popover" data-trigger="focus" data-placement="bottom" data-content="Work in progress!"><label class="btn btn-sm btn-light v4wbtn disabled" title="Percorso accessibile"><input type="checkbox" form="ricerca_ind" name="tide" id="tide_setting" disabled><img src="/static/icons/carrozzina.svg" class="icon"></input></label></span>
												<span tabindex="0" class="d-inline-block" data-toggle="popover" data-trigger="focus" data-placement="bottom" data-content="Work in progress!"><label class="btn btn-sm btn-light v4wbtn disabled" title="Percorso con i battelli"><input type="checkbox" form="ricerca_ind" name="ambu" id="ambu_setting" disabled><img src="/static/icons/battello.svg" class="icon"></i></input></label></span>
												<script>
												if(typeof dict_in_JS !== 'undefined'){
													checkTheBoxesThatNeedToBeChecked(dict_in_JS);
												};
												</script>
											</div>
										</div>
										<!-- <div class="col-1">
											<button type="submit" class="btn btn-sm btn-light v4wbtn"><i class="fa fa-fw fa-map-signs"></i></button>
											<!-- <button type="submit" class="btn btn-sm btn-light v4wbtn">Vai!</button> -->
											<!-- <button type="submit" class="btn btn-sm btn-light v4wbtn"><i class="fa fa-fw fa-search"></i></button> -->
										<!-- </div> -->
									</div>
									<!-- QUARTA RIGA: TROVA LA STRADA -->
									<!--
									<div class="row space_above">
										<div class="col-lg-4">
											<button type="submit" class="btn v4wbtn">Trova la strada &nbsp; <i class="fa fa-search"></i></button>
										</div>
									</div>
								-->
								</div> <!-- Chiudiamo seconde barre varie -->
								<!-- Hidden fields -->
								<input type="hidden" name="start_coord" id="start_coord">
								<input type="hidden" name="end_coord" id="end_coord">
							</form>
							<!-- Bottone per riaprire la sidebar -->
							<div class="container-fluid" id="show-sidebar" style="display:none">
								<div class="row space_above">
									<a onclick="showSidebar()">
										<button type=button class="btn btn-sm btn-light v4wbtn"><i class="fa fa-chevron-right"></i></button>
									</a>
								</div>
							</div>
						</div>
					</div>

					<div class="row">
							<!-- METTIAMO CARD CON RISULTATI SOTTO ALLE BARRE VARIE -->
						<div class="leaflet-control col-md-8 col-10">
								<div class="container-fluid" id="results_search" style="display:none;">
								<!-- PERCORSO -->
								<!--
								<div class="result_div" id="percorso">
									<p class="results_title">PERCORSO:</p>
									<p class="results_text">
									<!-->
									<div class="card" id="percorso">
									<div class="card-header container-fluid">
										<div class="row">
											<div class="col-9 align-self-center">
												PERCORSO
											</div>
											<div class="col-3 float-right">
											<!--<a onclick="closeResultsWindow()">-->
											<a onclick="moveResultsToSidebar()">
												<button class="btn btn-sm btn-outline-secondary float-right"><i class="fa fa-close"></i></button>
											</a>
											</div>
										</div>
									</div>
									<div class="card-body">
											DA:<br>
											<span id="da_text"></span><br>
											A:<br>
											<span id="a_text"></span><br>
											LUNGHEZZA:<br>
											<span id="length_text"></span><br>
											TEMPO:<br>
											<span id="time_text"></span><br>
											PONTI:<br>
											<span id="ponti_text"></span><br>
									</div>
								</div>
								<!-- RICERCA SINGLE -->
								<!--
								<div class="result_div" id="single_address">
									<p class="results_title">RICERCA:</p>
								-->
									<div class="card" id="single_address">
									<div class="card-header container-fluid">
										<div class="row">
											<div class="col-9 align-self-center">
												RICERCA
											</div>
											<div class="col-3 float-right">
												<!-- <a onclick="closeResultsWindow()"> -->
												<a onclick="moveResultsToSidebar()">
													<button class="btn btn-sm btn-outline-secondary float-right"><i class="fa fa-close"></i></button>
												</a>
											</div>
										</div>
									</div>
									<div class="card-body">
										<p class="results_text">
											TROVATO:<br>
											<span id="found_text"></span><br>
											TIPO:<br>
											<span id="type_text"></span><br>
									</div>
								</div>
								<!-- NON DOVREBBE APPARIRE -->
								<!--
								<div class="result_div" id="weird">
									<p class="results_title">STRANO:</p>
								-->
									<div class="card" id="weird">
									<div class="card-header">
										STRANO
										<!-- <a onclick="closeResultsWindow()"> -->
										<a onclick="moveResultsToSidebar()">
											<button class="btn v4wbtn Xbtn"><i class="fa fa-close"></i></button>
										</a>
									</div>
									<div class="card-body">
										<p class="results_text">
											Non dovrebbe mai apparire.<br>
											Probabilmente abbiamo sbagliato qualcosa.
										</p>
									</div>
								</div>
								</div>
							</div>
					</div>
					<!--</div> chiudiamo leaflet control -->
				</div>
				<div class="col-lg-4">
					<div class="leaflet-control">
						<div class="alert alert-danger alert-dismissible fade show" role="alert" id="errorwindow" style="display:none">
							<h4 class="alert-heading">C'è stato un errore!</h4>
							<p>È un po' imbarazzante, ma questo è anche il motivo per cui la versione si chiama <strong>alpha</strong>!<br>
								Qua sotto troverai una breve descrizione del problema… Noi abbiamo salvato un report dell'errore e tenteremo di risolverlo, se però vuoi darci più informazioni a riguardo puoi inviarci un <strong>feedback cliccando sulla zampa <img src="/static/img/dequa_logo_v2.png" style="width:12px;"></strong> in basso a destra. <br>
								Se hai boresso, puoi anche segnalare il bug su <a href="https://github.com/Lychfindel/v4w_website/issues" target="_" class="alert-link">github <i class="fa fa-github"></i></a> aprendo una issue!
							</p>
							<hr>
							<p class="mb-0" id="errorwindow-explanation">
							</p>
						  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
						    <span aria-hidden="true">&times;</span>
						  </button>
						</div>
						<div class="alert alert-success alert-dismissible fade show" role="alert" id="feedbackmessagewindow-success" style="display:none">
							Grazie per il feedback!
						  <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="top: -5px">
						    <span aria-hidden="true">&times;</span>
						  </button>
						</div>
						<div class="alert alert-danger alert-dismissible fade show" role="alert" id="feedbackmessagewindow-fail" style="display:none">
							Ops, qualcosa è andato storto nell'invio del feedback.<br>
							Per favore prova a reinviarlo.
						  <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="top: -5px">
						    <span aria-hidden="true">&times;</span>
						  </button>
						</div>
					</div>
				</div>
			</div>
		</div><!-- chiude leaflet-top -->

			<!-- DIV IN BASSO A SINISTRA - TIPO MAPPA -->
			<script>
				L.easyButton('fa fa-map',function(){
					changeMap(whichmap);
				},{position: 'bottomleft'}).addTo(mymap);
			</script>

			<!-- DIV IN BASSO A DESTRA SOPRA LO ZOOM - Zampa per la finestra d'aiuto -->
			<script>
				L.easyButton('<i class="fa fa-question-circle" aria-hidden="true"></i>',function(btn,map){
					showSettingsWindowNew();
				},{position: 'bottomright'}).addTo(mymap);
				// Functions for setting window
				function showSettingsWindowNew(){
					document.getElementById("settings-general").style.display = 'block';
					document.getElementById("settings-help").style.display = 'none';
					document.getElementById("settings-feedback").style.display = 'none';
					$('#settingsWindow').modal({show: true});
				};

				function showHelpWindowNew(){
					document.getElementById("settings-general").style.display = 'none';
					document.getElementById("settings-help").style.display = 'block';
				}

				function closeHelpWindowNew(){
					document.getElementById("settings-help").style.display = 'none';
				}

				function showFeedbackWindowNew(){
					document.getElementById("settings-general").style.display = 'none';
					document.getElementById("settings-feedback").style.display = 'block';
					// Dropdown choices:
					// (0, 'Oggetto non specificato')
					// (1, 'Indirizzo sbagliato')
					// (2, 'Strada sbagliata')
					// (3, 'Problemi di grafica')
					// (4, 'Proposta di miglioramento')
					// (5, 'Altro')
					document.getElementById("category").selectedIndex = 0;
				}

				function closeFeedbackWindowNew(){
					document.getElementById("settings-feedback").style.display = 'none';
				}
			</script>

			<!-- SETTING WINDOW: modal -->
			<!-- Modal -->
			<div class="modal fade" id="settingsWindow" tabindex="-1" role="dialog" aria-labelledby="Settings" aria-hidden="true">
			  <div class="modal-dialog modal-dialog-centered" role="document">
			    <div class="modal-content" id="settings-general">
			      <div class="modal-header">
			        <h5 class="modal-title">DeQua</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body">
			        <div class="row mb-4">
								<div class="col-6 text-center">
									<button class="btn btn-sq btn-default v4wbtn dequa_area" onclick="showHelpWindowNew()">
									<i class="fa fa-4x fa-question"></i>
									<br>
									<h6 class="mb-0">Aiuto</h6>
									</button>
								</div>
								<div class="col-6 text-center">
									<button class="btn btn-sq btn-default v4wbtn dequa_area" onclick="showFeedbackWindowNew()">
										<i class="fa fa-4x fa-exclamation-triangle"></i>
										<br>
										<h6 class="mb-0">Feedback</h6>
									</button>
								</div>
							</div>
							<div class="row">
								<div class="col-6 text-center">
									<a class="btn btn-sq btn-default v4wbtn dequa_area" style="color:inherit;" href="/info" target="_blank">
										<i class="fa fa-4x fa-user pt-2"></i>
										<br>
										<h6 class="mb-0">Info</h6>
									</a>
								</div>
								<div class="col-6 text-center">
									<a class="btn btn-sq btn-default v4wbtn dequa_area" style="color:inherit;" href="https://github.com/Lychfindel/v4w_website" target="_blank">
										<i class="fa fa-4x fa-github pt-2"></i>
										<br>
										<h6 class="mb-0 pb-0">GitHub</h6>
									</a>
								</div>
							</div>
			      </div>
						<div class="modal-footer">
							<small class="text-muted">Versione alpha</small>
						</div>
					</div>
					<div class="modal-content" id="settings-help" style="display: none">
						<div class="modal-header">
							<h5 class="modal-title">DeQua - Aiuto</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeHelpWindowNew()">
			          <span aria-hidden="true">&times;</span>
			        </button>
						</div>
						<div class="modal-body">
							<h3> Cerca il tuo indirizzo, o cerca un percorso tra due punti. </h3>
							<br>
							Tieni presente che il sito al momento è un cantiere aperto e stiamo lavorando a diverse migliorie, è quindi possibile che alcune cose non funzionino a dovere.<br>
							<br>
							Ciononostante, le funzionalità di base dovrebbero esserci: per esempio gli indirizzi dovrebbereo essere trovati e visualizzati correttamente,
							e le strade anche! <br>
							Offriamo anche la possibilità di scegliere la strada con meno ponti (icona col carretto <img src="/static/icons/carretto.svg" class="icon">)
							o calcolare il percorso in barca (icona col barchino <img src="/static/icons/barchin.svg" class="icon">).<br>
							Se trovate qualcosa che non va o volete dirci qualcosa, scriveteci a <a href="mailto:info@dequa.it">info@dequa.it</a>!<br>
							Se preferite, il form per il feedback si trova nel menu!<br>
							<br>
							Buona giornata.<br>
							I fioi.<br>
						</div>
					</div>
					<div class="modal-content" id="settings-feedback" style="display: none">
						<div class="modal-header">
							<h5 class="modal-title">DeQua - Feedback</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeFeedbackWindowNew()">
			          <span aria-hidden="true">&times;</span>
			        </button>
						</div>
						<div class="modal-body">
							<div class="form-group">
								<small class="form-text text-muted">Nessuno dei campi è obbligatorio e nessuna informazione verrà condivisa con terzi!</small>
							</div>
							<div id="formid">
								<form action="" method="post">
								{{ form.csrf_token }}

									<!-- {{ form.name.label }}
									{{ form.name(size=32) }} <br>
									{% for error in form.name.errors %}
							    	<span style="color: red;">[{{ error }}]</span>
							    {% endfor %} -->
								<div class="form-group">
									<label class="feedback-label" for="name">Nome</label>
									<input type="text" class="form-control" id="name" name="name" placeholder="Nome">
								</div>
								<!-- <div class="form-group">
									{{ form.email.label }}
									{{ form.email(size=32) }} <br>
									{% for error in form.email.errors %}
							    	<span style="color: red;">[{{ error }}]</span>
							    {% endfor %}
								</div> -->
								<div class="form-group">
									<label class="feedback-label" for="email">Email</label>
									<input type="text" class="form-control" id="email" name="email" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$">
									<small class="form-text text-muted">La tua mail è sacra: la useremo solo per chiederti chiarimenti o per avvisarti che il problema è risolto.</small>
								</div>
								<div class="form-group">
									<!-- {{ form.category.label }}
									{{ form.category() }}
									{% for error in form.category.errors %}
							    	<span style="color: red;">[{{ error }}]</span>
							    {% endfor %} -->
									<label class="feedback-label" for="category">Oggetto</label>
									<select class="form-control" id="category" name="category">
										{% for num,choice in form.category.choices %}
										<option value={{num}}>{{choice}}</option>
										{% endfor %}
										<!-- <option selected>Oggetto non specificato</option>
										<option>Indirizzo sbagliato</option>
										<option>Strada sbagliata</option>
										<option>Problemi di grafica</option>
										<option>Proposta di miglioramento</option>
										<option>Altro</option> -->
									</select>
								</div>
								<div class="form-group">
									<div class="row" id="form-search-address" style="display:none;">
										<div class="col">
										<!-- {{ form.searched_string.label }}
										{{ form.searched_string(size=32) }} -->
											<label class="feedback-label" for="searched_string">Ricerca</label>
											<input type="text" class="form-control" id="searched_string" name="searched_string" placeholder="Cosa hai cercato" readonly>
										</div>
									</div>
									<div class="row" id="form-search-path" style="display:none;">
										<div class="col-6">
											<label class="feedback-label" for="searched_start">Partenza</label>
											<input type="text" class="form-control" id="searched_start" name="searched_start" placeholder="La partenza che hai cercato" readonly>
										</div>
										<div class="col-6">
											<label class="feedback-label" for="searched_end">Arrivo</label>
											<input type="text" class="form-control" id="searched_end" name="searched_end" placeholder="L'arrivo che hai cercato" readonly>
										</div>
									</div>
								</div>
								<div class="form-group">
									<!-- {{ form.found_string.label }}
									{{ form.found_string(size=32) }} -->
									<div class="row" id="form-found-address" style="display:none;">
										<div class="col">
											<label class="feedback-label" for="found_string">Risultato</label>
											<input type="text" class="form-control" id="found_string" name="found_string" placeholder="Quello che abbiamo trovato" readonly>
										</div>
									</div>
									<div class="row" id="form-found-path" style="display:none;">
										<div class="col-6">
											<label class="feedback-label" for="found_start">Risultato partenza</label>
											<input type="text" class="form-control" id="found_start" name="found_start" placeholder="La partenza che hai cercato" readonly>
										</div>
										<div class="col-6">
											<label class="feedback-label" for="found_end">Risultato arrivo</label>
											<input type="text" class="form-control" id="found_end" name="found_end" placeholder="L'arrivo che hai cercato" readonly>
										</div>
									</div>
								</div>
								<div class="form-group">
							    <!-- {{ form.feedback.label }}<br>
							    {{ form.feedback(cols=50, rows=4) }}<br>
							    {% for error in form.feedback.errors %}
							    <span style="color: red;">[{{ error }}]</span>
							    {% endfor %} -->
									<label class="feedback-label" for="feedback">Problema o feedback</label>
									<textarea class="form-control" id="feedback" name="feedback" rows="3"></textarea>
									<small class="form-text text-muted">Più informazioni ci dai più semplice sarà per noi capire il problema e risolverlo!</small>
							  </div>
								<input type="hidden" name="dictJS" id="fbDict" value='{{results_dictionary|tojson}}'>
								<!-- <p>
									{{ form.submit() }}
								</p> -->
								<button type="submit" class="btn btn-secondary">Invia</button>
							</form>
							</div>
							<script>
								function formShowAddressField(){
									document.getElementById("form-search-path").style.display = 'none';
									document.getElementById("form-found-path").style.display = 'none';
									document.getElementById("form-search-address").style.display = 'block';
									document.getElementById("form-found-address").style.display = 'block';
								};
							</script>
						</div>
					</div>
				</div>
			</div>
		</div>
		</div>
	</div> <!-- Close map container -->
</div> <!-- Close container -->

<script>
		toggleXbuttons();
		document.getElementById("search_field_1").addEventListener("change", clear_hidden_start);
		document.getElementById("search_field_2").addEventListener("change", clear_hidden_end);

		// deal with feedback sent
		switch({{feedbacksent}}) {
			case -1:
				// error in the feedback
				document.getElementById("feedbackmessagewindow-fail").style.display = 'block';
				break;
			case 1:
				// feedback sent
				document.getElementById("feedbackmessagewindow-success").style.display = 'block';
				break;
		}
		var popup = L.popup();

		function onMapClick(e) {
			var address_string = e.latlng.toString();
			popup
					.setLatLng(e.latlng)
					.setContent("<div class='text-center'>Posizione: " + address_string + "<br><button  class='btn btn-sm btn-light v4wbtn mr-3' style='font-size: 0.8em;' id='btnMapStart'>DA QUA</button><button  class='btn btn-sm btn-light v4wbtn' style='font-size: 0.8em;' id='btnMapTo'>A</button><br></div>")
					.openOn(mymap);
			document.getElementById('btnMapStart').onclick = function() { copyStartingPosition(address_string); addMarkerStart(e.latlng); popup.remove();};
			document.getElementById('btnMapTo').onclick = function() { copyEndingPosition(address_string); addMarkerEnd(e.latlng);popup.remove();};
		}
		mymap.on('click', onMapClick);
		// HERE WE READ OUR JSON MESSAGE FROM PYTHON
		//var result = JSON.parse({{ results_dictionary | tojson }});
		var dict_in_JS = {{results_dictionary | tojson}};
		console.log("dict: ",dict_in_JS);
		// Set values on feedback window
		setValuesInFeedbackWindow(dict_in_JS);

		if (dict_in_JS == "None") {
			mymap.setView([45.435, 12.333], 15);
			hidebothXbuttons();
		} else if ("error" in dict_in_JS) {
			mymap.setView([45.435, 12.333], 15);
			console.log("error: " + dict_in_JS.msg)
			document.getElementById("errorwindow-explanation").innerHTML = dict_in_JS.msg;
			document.getElementById("errorwindow").style.display = 'block';
			//alert("Ahi ahi!!!\nOps... cossa xe nato :(\n"+dict_in_JS.msg)

		} else {
			mymap.setView([45.435, 12.333], 15);
			// options for all markers
			var marker_icon = L.icon({
				iconUrl: '/static/img/icon_marker_50.png',
				iconRetinaUrl: '/static/img/icon_marker.png',
				iconSize: [33, 50],
				iconAnchor: [16, 49],
				popupAnchor: [0, -40]
			});

			// Options for the marker
			var markerOptions = {
				 clickable: true,
				 // si alza all'hover - non va :(
				 riseOnHover: true,
				 icon: marker_icon
			}

			var modus_operandi = dict_in_JS.modus_operandi;
			console.log("siamo in modus_operandi: " + modus_operandi);
			var geo_type = dict_in_JS.partenza[0].geotype;
			console.log("geo_type in questo caso = " + geo_type);
			// we switch with modus_operandi
			// modus == 0 --> indirizzo, o nulla?
			// modus == 1 --> strada tra A e B
			switch(modus_operandi) {
				case 0:
					// here all the stuff we can do when only one address is searched
					// NEW VERSION with geo_type
					// geo_type == -2 --> pagina senza ricerca
					// geo_type == -1 --> trovato nulla, pazienza
					// geo_type == 0 --> marker, un punto solo
					// geo_type == 1 --> poligono
					// e facile aggiungere geo_type se vogliamo piu avanti
					showResultsWindow('single_address');
					console.log("shown a single address result")
					var name_location = dict_in_JS.params_research.da;
					document.getElementById('search_field_1').value = name_location
					if (name_location.length > 0) {
						nowitstimetoshowtheX('search_field_1_x');
					}
					// if we have the coordinate, we should keep it!
					if (dict_in_JS.params_research.start_coord.length > 0) {
						document.getElementById('hidden_start_coord').value = dict_in_JS.params_research.start_coord;
					}
					document.getElementById("found_text").innerHTML = "<i>"+name_location+"</i>";
					switch(geo_type) {
						case -2:
							// do nothing - pagina senza ricerca_ind
							mymap.setView([45.43, 12.33], 15);
							break;
						case -1: // in realta per ora non serve a nulla
							// code block
							alert('non abbiamo trovato nulla! Sicuro di aver scritto giusto? Riprova');
							break;
						case 0:
							// coordinate
							var coords_location = dict_in_JS.partenza[0].coordinate;
							marker_location = L.marker(coords_location, markerOptions);
							document.getElementById("type_text").innerHTML = "<i>indirizzo</i>";
							// Popup se uno clicca sul marker
							marker_location.bindPopup("Abbiamo trovato " + name_location).openPopup();
							// aggiungi il marker sulla mappa
							marker_location.addTo(mymap);
							var group = new L.featureGroup([marker_location]);
							mymap.fitBounds(group.getBounds());
							//mymap.setView([{{start_coordx}}, {{start_coordy}}], 18);
							break;
						case 1:
							// DISEGNA POLIGONO
							var polygonOptions = {

								 title: "Evidenziato " + name_location,
								 clickable: true,
								 // si alza all'hover - non va :(
								 riseOnHover: true
							}
							// var polygon = L.polygon([
							// 		dict_in_JS.partenza[0].shape
							// ], polygonOptions).addTo(mymap);
							// var group = new L.featureGroup([polygon]);
							document.getElementById("type_text").innerHTML = "<i>area</i>";
							console.log("geojson: "+ dict_in_JS.partenza[0].geojson);
							// Per qualche motivo dice che il geojson è fatto male
							var polygon = L.geoJSON(dict_in_JS.partenza[0].geojson);
							polygon.addTo(mymap);
							mymap.fitBounds(polygon.getBounds());
							//mymap.setView([{{start_coordx}}, {{start_coordy}}], 17);
							break;
						default:
							// do nothing
							console.log("caso default. strano. guarda nello switch che valore ha geo_type");
							break;
						}
					break;
				// MODUS OPERANDI == 1 --> PERCORSO DA A a B
				case 1:
					// geo type is not used
					console.log("Setting up results window!")
					showResultsWindow('percorso');
					var nome_partenza = dict_in_JS.params_research.da;
					document.getElementById("da_text").innerHTML = "<i>"+nome_partenza+"</i>";
					var nome_arrivo = dict_in_JS.params_research.a;
					document.getElementById("a_text").innerHTML = "<i>"+nome_arrivo+"</i>";
					var path_length = dict_in_JS.path.human_readable_length;
					document.getElementById("length_text").innerHTML = "<i>"+path_length+"</i>";
					var time_description = dict_in_JS.path.human_readable_time;
					document.getElementById("time_text").innerHTML = "<i>"+time_description+"</i>";
					var num_of_bridges = dict_in_JS.path.n_ponti;
					document.getElementById("ponti_text").innerHTML = "<i>strada con "+num_of_bridges+" ponti</i>";
					console.log("also the search should be ready");
					showSecondSearchbar();
					document.getElementById('search_field_1').value = nome_partenza;
					if (nome_partenza.length > 0) {
						nowitstimetoshowtheX('search_field_1_x');
					}
					// if we have the coordinate, we should keep it!
					if (dict_in_JS.params_research.start_coord.length > 0) {
						document.getElementById('hidden_start_coord').value = dict_in_JS.params_research.start_coord;
					}
					document.getElementById('search_field_2').value = nome_arrivo;
					if (nome_arrivo.length > 0) {
						nowitstimetoshowtheX('search_field_2_x');
					}
					// if we have the coordinate, we should keep it!
					if (dict_in_JS.params_research.end_coord.length > 0) {
						document.getElementById('hidden_end_coord').value = dict_in_JS.params_research.end_coord;
					}
					else if (dict_in_JS.end_type == 'unique' && dict_in_JS.arrivo[0].coordinate.lenght > 0) {
						document.getElementById('hidden_end_coord').value = dict_in_JS.arrivo[0].coordinate;
					}
					else {
						console.log("[modus 1]: seems like we are not using end_coord! is this correct?")
					}
					console.log("checking the boxes");
					checkTheBoxesThatNeedToBeChecked(dict_in_JS);
					console.log("done checking the boxes");
					console.log("drawing the streets!")

					// here all the stuff when we have path from A to B
			    //var punto_di_partenza = L.point(stop_coordx, stop_coordy);
			    //var prj = L.Projection.Mercator.unproject(pointM);
					mymap.setView([45.43, 12.33], 13);
			    var marker_partenza = L.marker([dict_in_JS.partenza[0].coordinate[0], dict_in_JS.partenza[0].coordinate[1]], markerOptions).setIcon(greenIcon).addTo(mymap);
			    var marker_arrivo = L.marker([dict_in_JS.arrivo[0].coordinate[0], dict_in_JS.arrivo[0].coordinate[1]], markerOptions).setIcon(redIcon).addTo(mymap);
					// the pahts: they are more than one
					var street = dict_in_JS.path;
					var group = new L.featureGroup([marker_partenza, marker_arrivo]);
					//console.log("steets: " + streets);
					path_shapes = street.shape_list;
						//var linestrings = L.geoJSON(path_shapes, {'style':stile});
					var linestrings = L.geoJSON(path_shapes, {
							filter: function(feature) {
								// draw only lines!
								return feature.geometry.type == "LineString";
							},
					    style: function(feature) {
					        switch (feature.properties.street_type) {
					            case 'canale': return {color: "#0000ff"};
					            case 'ponte':  return {color: "#ffff00"};
											case 'calle':  return {color: "#ff0000"};
					        }
					    }
					}).addTo(mymap);
					linestrings.addTo(group);
					mymap.fitBounds(group.getBounds(), {padding: [10, 10]});
					// javascript way to call a method in the for loop
					//streets.forEach(drawStreet());
					//alert('YET TO BE DONE');
					break;
				// MODUS OPERANDI == 2 --> Non siamo sicuri della soluzione
				case 2:
					console.log("Setting up possiblities window!")
					var possibilities = "";
					var what_we_know = "nothing";
					var start_found = "";
					var end_found = "";
					var tmp_start = dict_in_JS.searched_start;
					var tmp_end = dict_in_JS.searched_end;
					console.log("Finished setting up possiblities window!");
					console.log("checking the boxes");
					checkTheBoxesThatNeedToBeChecked(dict_in_JS);
					console.log("done checking the boxes");
					// we are looking for path
					// if (dict_in_JS.start_type == 'unique') {
					// 	//dict_in_JS.end_type == 'multiple'
					// 	possibilities = dict_in_JS.arrivo;
					// 	what_we_know = "choosing_end";
					// 	start_found = dict_in_JS.partenza[0];
					// } else if (tmp_end) {
					// 	possibilities = dict_in_JS.partenza;
					// 	what_we_know = "choosing_start";
					// } else { // tmp_end is empty
					// 	possibilities = dict_in_JS.partenza;
					// 	what_we_know = "address";
					// }

					if ((dict_in_JS.start_type == 'multiple') && (dict_in_JS.end_type == 'multiple')){
						// possibilities[0] = dict_in_JS.partenza;
						// possibilities[1] = dict_in_JS.arrivo;
						// what_we_know = "choosing_both";
						possibilities = dict_in_JS.partenza;
						what_we_know = "choosing_start";
					} else if ((dict_in_JS.start_type == 'unique') && (dict_in_JS.end_type == 'multiple')) {
						// possibilities[0] = "";
						// possibilities[1] = dict_in_JS.arrivo;
						possibilities = dict_in_JS.arrivo;
						start_found = dict_in_JS.partenza[0];
						what_we_know = "choosing_end";
					} else if ((dict_in_JS.start_type == 'multiple') && (dict_in_JS.end_type == 'unique')) {
						// possibilities[0] = dict_in_JS.partenza;
						// possibilities[1] = "";
						possibilities = dict_in_JS.partenza;
						if (tmp_end) {
							end_found = dict_in_JS.arrivo[0];
							what_we_know = "choosing_start";
						} else {
							what_we_know = "address";
						}
					} else{
						what_we_know = "nothing";
					}
					console.log("We send this to js: ",markerOptions)
					// showPossibilitiesWindow(possibilities, markerOptions, mymap, what_we_know, tmp_start, tmp_end, start_found, end_found);
					showPossibilitiesWindow(possibilities, markerOptions, mymap, what_we_know, tmp_start, tmp_end, start_found);

					// sbagliamo a scrivere sulle barre! Da correggere in showPossibilitiesWindow
					// o ancora meglio separare possibilities window dallo scrivere sulle barre
					var nome_partenza = dict_in_JS.params_research.da;
					document.getElementById("search_field_1").value = nome_partenza;
					var nome_arrivo = dict_in_JS.params_research.a;
					document.getElementById("search_field_2").value = nome_arrivo;

					showSecondSearchbar();
					document.getElementById('search_field_1').value = nome_partenza;
					//keep coordinates
					// if we have the start coordinate, we should keep it!
					if (dict_in_JS.params_research.start_coord.length > 0) {
						document.getElementById('hidden_start_coord').value = dict_in_JS.params_research.start_coord;
					}
					// if we have the end coordinate, we should keep it!
					if (dict_in_JS.params_research.end_coord.length > 0) {
						document.getElementById('hidden_end_coord').value = dict_in_JS.params_research.end_coord;
					}
					//possibilitiesLayer.addTo(mymap);
					mymap.fitBounds(possibilitiesLayer.getBounds());
					/*$(document).ready(function(){
					  $(".owl-carousel").owlCarousel();
					});*/
					console.log("done here");
					break;
				break; // final default break
		 	}//closing switch modus_operandi

		}
		/* Primo tentativo!
		window.addEventListener('locationchange', function() {
			if (document.getElementById("loading").style.display = "inline") {
  			document.getElementById("loading").style.display = "none";
  			document.getElementById("mapid").style.opacity = 1;
  		}
	    console.log('location changed!');
		})*/
		// sembra funzionare semplicemente per l'esistenza di questo HandleBackFunctionality,
		// ma in realtà non printa nulla a console, forse non entra mai, ma sparisce la rotella
		// MISTERO
		function HandleBackFunctionality()
		{
			/*
			if (document.getElementById("loading").style.display = "inline") {
  			document.getElementById("loading").style.display = "none";
  			document.getElementById("mapid").style.opacity = 1;
  		}
	    console.log('tolto la rotella');
			*/
		}
</script>


</body>
</html>
