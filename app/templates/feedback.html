<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- Non dovrebbe essere indicizzato -->
		<meta name="robots" content="noindex">
		<meta name="googlebot" content="noindex">
    <link rel="icon" href="/static/img/dequa_logo_v2.png">
    <link rel="stylesheet" href="/static/css/leaflet.css">
    <link rel="stylesheet" href="/static/css/L.Control.Locate.min.css">

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="/static/js/leaflet.js"></script>
    <script src="/static/js/L.Control.Locate.min.js"></script>
    <!-- PROVIDERS FOR DIFFERENT MAP TYPES -->
    <script src="/static/js/leaflet-providers.js"></script>
    <title>DeQua Feedback</title>
    <!-- Bootstrap core CSS -->
		<link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/s.css" rel="stylesheet">
	</head>
	<body>
    <script>var feedback_dict_in_JS = {{feedback_dict | tojson}};</script>

		<div class="container">
			<div class="header_feedback">
				<div class="row">
					<div class="col-md-1"><img src="/static/img/dequa_logo_v2.png" width="100%"></div>
					<div class="col-md-11">
            <div class="title">DeQua Feedback</div>
            <div class="feedback_count" id="fb_count"></div>
          </div>
				</div>
			</div>

      <div class="feedbacks" id="feedback_container">
        <div class="row" id="feedback_row">
          <div class="col-md-3 fb-col" id="left_col"></div>
          <div class="col-md-5" id="map_feedback" style='width:100%; height:30em;'>asdas</div>
          <div class="col-md-4 fb-col" id="right_col"></div>
        </div>
      </div>

      <script>
        var fb_map = L.map('map_feedback').setView([45.435, 12.333], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					minZoom: 10,
					maxZoom: 19,
					minNativeZoom: 10,
					maxNativeZoom: 19,
					zoomControl: false,
					attribution: 'DeQua | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(fb_map);
      </script>
		</div><!-- END OF BIG CONTAINER (whole page) -->

	</body>
  <script>
    var fb_names = feedback_dict_in_JS.fb_names;
    var fb_contents = feedback_dict_in_JS.fb_contents;
    var fb_dicts = feedback_dict_in_JS.fb_dicts;
    var markers_group = L.layerGroup();
    var pathLines = L.geoJSON([],{
      filter: function(feature) {
        // draw only lines!
        return feature.geometry.type == "LineString";
      },
      style: function(feature) {
        switch (feature.properties.street_type) {
          case 'canale': return {color: "#0000ff"};
          case 'ponte':  return {color: "#ffff00"};
          case 'calle':  return {color: "#ff0000"};
        }
      }
    });
    for (i=0; i<fb_names.length; i++) (function(i){
      var div_left_col = document.createElement("div");
      var div_right_col = document.createElement("div");
      // a div contains the text (this will later be better made, with maps and all)
      var div_container = document.createElement("div");
      div_container.classList.add("fb_content");
      div_container.id = "fb_content" + i; // we need id to toggle the visibility (or at least I think)
      div_container.style.display = "none";
      var item_text = document.createElement("div");
      item_text.innerHTML = "<h3>" + fb_dicts[i]['title'] + "</h3>" + "<br> infos: " + fb_dicts[i]['infos'] + "<br> json: " + fb_dicts[i]['json_to_be_drawn'];

      // prepara i json
      // qui vengono salvati i dati sul container in modo da poterli avere
      // dentro il metodo del toggle
      var lines = fb_dicts[i]['json_to_be_drawn'];
      console.log('lines:' + lines);
      div_container.json_lines = lines;
      div_container.marker_partenza = fb_dicts[i].json_to_be_drawn.partenza;
      console.log('container attribute ' + div_container.json_lines);
      // the content of the file is a hidden div that
      var list_item = document.createElement("div");
      list_item.classList.add("fb_name");
      list_item.innerHTML = fb_names[i];
      list_item.id = "fb_name" + i;
      list_item.onclick = function() { toggle_content(div_container.id, list_item.id); };

      // here we build the structure, so:
      // -- feedback_container
      //  |-- row
      //    |-- col-3
      //      |-- list_item
      //    |-- col-9
      //      |-- div_container
      //        |-- item_text
      div_container.appendChild(item_text);
      div_right_col.appendChild(div_container);
      div_left_col.appendChild(list_item);
      document.getElementById("left_col").appendChild(div_left_col);
      document.getElementById("right_col").appendChild(div_right_col);
    })(i);

    // hide the contents and show the one we clicked
    function toggle_content(el_id, list_id) {
      // if it's already open, just close it
      if (document.getElementById(el_id).style.display == "inline") {
        document.getElementById(el_id).style.display = "none";
        document.getElementById(list_id).style.color = "black";
      }
      else {
        // close all the others
        console.log("trying to show " + el_id);
        var fb_contents = document.getElementsByClassName("fb_content");
        for (j=0; j<fb_contents.length; j++) {
          fb_contents[j].style.display = "none";
        }
        // put it back to black color
        var fb_names = document.getElementsByClassName("fb_name");
        for (j=0; j<fb_names.length; j++) {
          fb_names[j].style.color = "black";
        }
        //show the good goood one
        document.getElementById(el_id).style.display = "inline";
        // color blue to show it's active
        console.log("coloring the list " + el_id);
        document.getElementById(list_id).style.color = "blue";
      }
      pathLines.clearLayers();
      // un bel modo barbaro per eliminare i marker
      // sicuramente c'Ã¨ una soluzione migliore
      markers_group = L.layerGroup();
      // draw the lines
      var lines = document.getElementById(el_id).json_lines.path.shape_list;
      pathLines.addData(lines);
    	pathLines.addTo(fb_map);
      var marker = document.getElementById(el_id).json_lines.path.shape_list;
      fb_map.fitBounds(pathLines.getBounds(), {paddingTopLeft: [10, 10], paddingBottomRight: [10,10]});
    }
  </script>
  <script>
    var fb_names = feedback_dict_in_JS.fb_names;
    // set the html for the counter
    document.getElementById('fb_count').innerHTML = "Ci sono " + fb_names.length + " files di feedback";
  </script>

</html>
